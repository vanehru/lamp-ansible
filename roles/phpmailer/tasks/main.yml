---
# PHPMailer Role - PHPMailer Installation and Azure Email Services Configuration
# This role installs PHPMailer and configures it to work with Azure Communication Services

- name: Install required PHP extensions for PHPMailer
  dnf:
    name:
      - php-mbstring
      - php-xml
      - php-curl
    state: present
  notify: restart apache
  tags: ['phpmailer', 'packages']

- name: Check if Composer is installed
  stat:
    path: /usr/local/bin/composer
  register: composer_installed
  tags: ['phpmailer', 'composer']

- name: Download Composer installer
  get_url:
    url: https://getcomposer.org/installer
    dest: /tmp/composer-setup.php
    mode: '0755'
  when: not composer_installed.stat.exists
  tags: ['phpmailer', 'composer']

- name: Install Composer
  command: php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
  when: not composer_installed.stat.exists
  tags: ['phpmailer', 'composer']

- name: Remove Composer installer
  file:
    path: /tmp/composer-setup.php
    state: absent
  when: not composer_installed.stat.exists
  tags: ['phpmailer', 'composer']

- name: Verify Composer installation
  command: /usr/local/bin/composer --version
  register: composer_version
  changed_when: false
  tags: ['phpmailer', 'composer']

- name: Display Composer version
  debug:
    msg: "Composer installed: {{ composer_version.stdout }}"
  tags: ['phpmailer', 'composer']

- name: Create PHPMailer directory
  file:
    path: "{{ phpmailer_install_dir }}"
    state: directory
    owner: apache
    group: apache
    mode: '0755'
  tags: ['phpmailer', 'setup']

- name: Create composer.json for PHPMailer
  copy:
    content: |
      {
        "require": {
          "phpmailer/phpmailer": "^6.9"
        }
      }
    dest: "{{ phpmailer_install_dir }}/composer.json"
    owner: apache
    group: apache
    mode: '0644'
  tags: ['phpmailer', 'setup']

- name: Install PHPMailer via Composer
  command: /usr/local/bin/composer install --no-dev --optimize-autoloader
  args:
    chdir: "{{ phpmailer_install_dir }}"
  become_user: apache
  register: composer_install

- name: Display PHPMailer installation result
  debug:
    msg: "PHPMailer installation completed"
  tags: ['phpmailer', 'install']

- name: Deploy PHPMailer configuration file
  template:
    src: mailer_config.php.j2
    dest: "{{ phpmailer_install_dir }}/mailer_config.php"
    owner: apache
    group: apache
    mode: '0640'
  tags: ['phpmailer', 'config']

- name: Deploy email test script
  template:
    src: test_email.php.j2
    dest: "{{ apache_document_root }}/test_email.php"
    owner: apache
    group: apache
    mode: '0644'
  tags: ['phpmailer', 'test']

- name: Deploy email sending example script
  template:
    src: send_email_example.php.j2
    dest: "{{ apache_document_root }}/send_email_example.php"
    owner: apache
    group: apache
    mode: '0644'
  tags: ['phpmailer', 'examples']

- name: Configure SELinux to allow PHP to send emails
  command: setsebool -P httpd_can_sendmail on
  when: ansible_selinux.status == "enabled"
  failed_when: false
  changed_when: false
  tags: ['phpmailer', 'selinux']

- name: Configure SELinux to allow network connections
  command: setsebool -P httpd_can_network_connect on
  when: ansible_selinux.status == "enabled"
  failed_when: false
  changed_when: false
  tags: ['phpmailer', 'selinux']

- name: Allow SMTP port through firewall (587 - STARTTLS)
  command: firewall-cmd --permanent --add-port=587/tcp
  when: firewall_enabled | default(true)
  failed_when: false
  changed_when: false
  tags: ['phpmailer', 'firewall']

- name: Allow SMTP SSL port through firewall (465)
  command: firewall-cmd --permanent --add-port=465/tcp
  when: firewall_enabled | default(true)
  failed_when: false
  changed_when: false
  tags: ['phpmailer', 'firewall']

- name: Reload firewall for SMTP ports
  command: firewall-cmd --reload
  when: firewall_enabled | default(true)
  failed_when: false
  changed_when: false
  tags: ['phpmailer', 'firewall']

- name: Create PHPMailer logs directory
  file:
    path: /var/log/phpmailer
    state: directory
    owner: apache
    group: apache
    mode: '0755'
  tags: ['phpmailer', 'logging']

- name: Set SELinux context for PHPMailer logs
  command: semanage fcontext -a -t httpd_log_t '/var/log/phpmailer(/.*)?'
  when: ansible_selinux.status == "enabled"
  failed_when: false
  changed_when: false
  tags: ['phpmailer', 'selinux']

- name: Apply SELinux context to PHPMailer logs
  command: restorecon -Rv /var/log/phpmailer
  when: ansible_selinux.status == "enabled"
  changed_when: false
  tags: ['phpmailer', 'selinux']

- name: Display PHPMailer setup completion message
  debug:
    msg:
      - "PHPMailer installation and configuration completed!"
      - "Configuration file: {{ phpmailer_install_dir }}/mailer_config.php"
      - "Test email script: http://{{ ansible_default_ipv4.address }}/test_email.php"
      - "Example script: http://{{ ansible_default_ipv4.address }}/send_email_example.php"
      - "Azure SMTP Host: {{ azure_smtp_host }}"
      - "Azure SMTP Port: {{ azure_smtp_port }}"
  tags: ['phpmailer', 'info']
