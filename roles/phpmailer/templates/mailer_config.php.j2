<?php
/**
 * PHPMailer Configuration for Azure Communication Services
 * 
 * This configuration file contains settings for sending emails
 * through Azure Communication Services SMTP relay.
 * 
 * SECURITY WARNING: This file contains sensitive credentials.
 * Ensure proper file permissions are set (0640) and never commit
 * credentials to version control.
 * 
 * Generated by Ansible - Do not edit manually
 */

// Azure Communication Services SMTP Configuration
define('AZURE_SMTP_HOST', '{{ azure_smtp_host }}');
define('AZURE_SMTP_PORT', {{ azure_smtp_port }});
define('AZURE_SMTP_USERNAME', '{{ azure_smtp_username }}');
define('AZURE_SMTP_PASSWORD', '{{ azure_smtp_password }}');
define('AZURE_SMTP_ENCRYPTION', '{{ azure_smtp_encryption }}'); // 'tls' or 'ssl'

// Sender Configuration
define('MAIL_FROM_ADDRESS', '{{ mail_from_address }}');
define('MAIL_FROM_NAME', '{{ mail_from_name }}');

// Default Settings
define('MAIL_CHARSET', 'UTF-8');
define('MAIL_TIMEOUT', 30);
define('MAIL_DEBUG_LEVEL', {{ mail_debug_level }}); // 0=off, 1=client, 2=server, 3=connection, 4=lowlevel

// Logging
define('MAIL_LOG_ENABLED', {{ mail_log_enabled | lower }});
define('MAIL_LOG_PATH', '{{ mail_log_path }}');

/**
 * Get configured PHPMailer instance
 * 
 * @return PHPMailer\PHPMailer\PHPMailer
 * @throws Exception
 */
function getMailer() {
    require_once '{{ phpmailer_install_dir }}/vendor/autoload.php';
    
    $mail = new PHPMailer\PHPMailer\PHPMailer(true);
    
    try {
        // Server settings
        $mail->isSMTP();
        $mail->Host       = AZURE_SMTP_HOST;
        $mail->SMTPAuth   = true;
        $mail->Username   = AZURE_SMTP_USERNAME;
        $mail->Password   = AZURE_SMTP_PASSWORD;
        $mail->SMTPSecure = AZURE_SMTP_ENCRYPTION;
        $mail->Port       = AZURE_SMTP_PORT;
        $mail->Timeout    = MAIL_TIMEOUT;
        
        // Debug settings
        $mail->SMTPDebug  = MAIL_DEBUG_LEVEL;
        $mail->Debugoutput = function($str, $level) {
            if (MAIL_LOG_ENABLED) {
                $logFile = MAIL_LOG_PATH . '/phpmailer_' . date('Y-m-d') . '.log';
                $timestamp = date('Y-m-d H:i:s');
                file_put_contents($logFile, "[$timestamp] $str\n", FILE_APPEND);
            }
        };
        
        // Default sender
        $mail->setFrom(MAIL_FROM_ADDRESS, MAIL_FROM_NAME);
        
        // Content settings
        $mail->CharSet = MAIL_CHARSET;
        $mail->isHTML(true);
        
        return $mail;
        
    } catch (Exception $e) {
        if (MAIL_LOG_ENABLED) {
            $logFile = MAIL_LOG_PATH . '/phpmailer_errors_' . date('Y-m-d') . '.log';
            $timestamp = date('Y-m-d H:i:s');
            file_put_contents($logFile, "[$timestamp] Error creating mailer: {$e->getMessage()}\n", FILE_APPEND);
        }
        throw $e;
    }
}

/**
 * Send a simple email
 * 
 * @param string $to Recipient email address
 * @param string $subject Email subject
 * @param string $body Email body (HTML)
 * @param string $altBody Plain text alternative body
 * @return bool Success status
 */
function sendEmail($to, $subject, $body, $altBody = '') {
    try {
        $mail = getMailer();
        
        $mail->addAddress($to);
        $mail->Subject = $subject;
        $mail->Body    = $body;
        $mail->AltBody = $altBody ?: strip_tags($body);
        
        $result = $mail->send();
        
        if (MAIL_LOG_ENABLED && $result) {
            $logFile = MAIL_LOG_PATH . '/phpmailer_sent_' . date('Y-m-d') . '.log';
            $timestamp = date('Y-m-d H:i:s');
            file_put_contents($logFile, "[$timestamp] Email sent to: $to | Subject: $subject\n", FILE_APPEND);
        }
        
        return $result;
        
    } catch (Exception $e) {
        if (MAIL_LOG_ENABLED) {
            $logFile = MAIL_LOG_PATH . '/phpmailer_errors_' . date('Y-m-d') . '.log';
            $timestamp = date('Y-m-d H:i:s');
            file_put_contents($logFile, "[$timestamp] Error sending email: {$e->getMessage()}\n", FILE_APPEND);
        }
        return false;
    }
}

/**
 * Send email with attachments
 * 
 * @param string $to Recipient email address
 * @param string $subject Email subject
 * @param string $body Email body (HTML)
 * @param array $attachments Array of file paths to attach
 * @param string $altBody Plain text alternative body
 * @return bool Success status
 */
function sendEmailWithAttachments($to, $subject, $body, $attachments = [], $altBody = '') {
    try {
        $mail = getMailer();
        
        $mail->addAddress($to);
        $mail->Subject = $subject;
        $mail->Body    = $body;
        $mail->AltBody = $altBody ?: strip_tags($body);
        
        // Add attachments
        foreach ($attachments as $attachment) {
            if (file_exists($attachment)) {
                $mail->addAttachment($attachment);
            }
        }
        
        $result = $mail->send();
        
        if (MAIL_LOG_ENABLED && $result) {
            $logFile = MAIL_LOG_PATH . '/phpmailer_sent_' . date('Y-m-d') . '.log';
            $timestamp = date('Y-m-d H:i:s');
            $attachCount = count($attachments);
            file_put_contents($logFile, "[$timestamp] Email with $attachCount attachment(s) sent to: $to | Subject: $subject\n", FILE_APPEND);
        }
        
        return $result;
        
    } catch (Exception $e) {
        if (MAIL_LOG_ENABLED) {
            $logFile = MAIL_LOG_PATH . '/phpmailer_errors_' . date('Y-m-d') . '.log';
            $timestamp = date('Y-m-d H:i:s');
            file_put_contents($logFile, "[$timestamp] Error sending email with attachments: {$e->getMessage()}\n", FILE_APPEND);
        }
        return false;
    }
}
