---
# Common Role - System Setup and Prerequisites
# This role handles basic system configuration and updates

- name: Update all packages to latest version
  dnf:
    name: '*'
    state: latest
    update_cache: yes
  tags: ['packages', 'update']

- name: Install EPEL repository for RHEL 9
  dnf:
    name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm"
    state: present
    disable_gpg_check: yes
  when: ansible_distribution == "RedHat" and ansible_distribution_major_version == "9"
  tags: ['packages', 'epel']

- name: Install EPEL repository for RHEL 8
  dnf:
    name: epel-release
    state: present
  when: ansible_distribution == "RedHat" and ansible_distribution_major_version == "8"
  tags: ['packages', 'epel']

- name: Install EPEL repository for CentOS
  dnf:
    name: epel-release
    state: present
  when: ansible_distribution == "CentOS"
  tags: ['packages', 'epel']

- name: Install common required packages
  dnf:
    name:
      - vim
      - wget
      - curl
      - git
      - net-tools
      - policycoreutils-python-utils
      - setroubleshoot-server
    state: present
  tags: ['packages']

- name: Fail if timezone variable is not defined
  fail:
    msg: "The 'timezone' variable must be defined (e.g., timezone: 'UTC')."
  when: timezone is not defined
  tags: ['timezone']

- name: Set timezone
  timezone:
    name: "{{ timezone }}"
  when: timezone is defined
  tags: ['timezone']

- name: Ensure firewalld is installed
  dnf:
    name: firewalld
    state: present
  when: firewall_enabled | bool
  tags: ['firewall']

- name: Start and enable firewalld
  systemd:
    name: firewalld
    state: started
    enabled: yes
  when: firewall_enabled | bool
  failed_when: false
  tags: ['firewall']

- name: Display system information
  debug:
    msg:
      - "Hostname: {{ ansible_hostname }}"
      - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - "Kernel: {{ ansible_kernel }}"
      - "Architecture: {{ ansible_architecture }}"
  ignore_errors: true
  tags: ['info']
